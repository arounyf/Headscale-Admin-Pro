<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>系统设置</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="/static/adminui/dist/css/admin.css" media="all">
</head>

  <body class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-col-md8">
        <div class="layui-card">
          <div class="layui-card-header">系统设置</div>
          <div class="layui-card-body" pad15>
            
            <div class="layui-form" wid100 lay-filter="" >


              <div class="layui-form-item">
                  <label class="layui-form-label">apiKey</label>

                  <div class="layui-input-inline" style="width:395px">
                    <input type="password" name="apiKey" lay-verify="required" autocomplete="off"   value="{{ apikey }}" class="layui-input" lay-affix="eye"  >
                  </div>
                  <div class="layui-form-mid" style="padding: 0!important;">
                    <button type="button" class="layui-btn layui-btn-primary" lay-on="get_apikey">自动生成</button>
                  </div>
                  <div class="layui-form-mid layui-word-aux">apikey是与headscale通信的凭证</div>

               </div>


              <div class="layui-form-item">
                <label class="layui-form-label">server url</label>
                <div class="layui-input-inline" style="width:500px">
                  <input type="text" name="serverUrl" lay-verify="required" value="{{ server_url }}" class="layui-input"  >

                </div>
                <div class="layui-form-mid layui-word-aux">headscale对外提供服务的URL</div>
              </div>


              <div class="layui-form-item">
                <label class="layui-form-label">新用户默认天数</label>
                <div class="layui-input-inline" style="width:300px">
                  <input type="text" name="defaultRegDays" lay-verify="required" value="{{ default_reg_days }}" class="layui-input">
                </div>
                <div class="layui-form-mid layui-word-aux">新用户注册默认到期天数,0代表默认禁用</div>
              </div>

              <div class="layui-form-item">
                <label class="layui-form-label">默认节点限制</label>
                <div class="layui-input-inline" style="width:300px">
                  <input type="text" name="defaultNodeCount" lay-verify="required" value="{{ default_node_count }}" class="layui-input" >
                </div>
                <div class="layui-form-mid layui-word-aux">新用户注册默认节点数量限制</div>
              </div>

              <div class="layui-form-item">
                <label class="layui-form-label">对外注册</label>
                <div class="layui-input-inline" style="width:80px">
                  <input type="checkbox" name="openUserReg" lay-skin="switch" lay-text="开启|关闭" title="开启|关闭" lay-filter="open_user_reg_switch"
                     {{ open_user_reg }}     ><div class="layui-unselect layui-form-switch" lay-skin="switch" ><div>关闭</div><i></i></div>
                </div>
                <div class="layui-form-mid layui-word-aux">是否允许新用户注册</div>
              </div>

              <div class="layui-form-item">
                <label class="layui-form-label">网卡名</label>

{#                  <input type="text" name="serverNet" lay-verify="required"  value="{{ server_net }}" class="layui-input">#}
                    <div class="layui-input-inline" style="width:300px">
                      <select name="serverNet">
                        <option value=""></option>
{#                        <option value="0">写作</option>#}
{#                        <option value="1" selected>阅读</option>#}
                          {{ server_net|safe }}
                      </select>
                    </div>


                <div class="layui-form-mid layui-word-aux">流量统计使用</div>
              </div>

              
              <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">服务器分布代码</label>
                <div class="layui-input-block">
                  <textarea name="regionHtml" class="layui-textarea"  lay-verify="required" >{{ region_html }}</textarea>
                </div>
              </div>


              <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">服务器分布数据</label>
                <div class="layui-input-block">
                  <textarea name="regionData" class="layui-textarea"  lay-verify="required" >{{ region_data }}</textarea>
                </div>
              </div>



              <div class="layui-form-item">
                <div class="layui-input-block">
                  <button class="layui-btn" lay-submit lay-filter="set_config">确认保存</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>





        <div class="layui-col-md4">
            <div class="layui-card layui-form" lay-filter="component-form-element">
                <div class="layui-card-header">headscale 进程管理</div>
                    <div class="layui-card-body layui-row layui-col-space10">
                    <div class="layui-col-md12">
                        <input type="checkbox" name="zzz" lay-skin="switch" lay-text="开启|关闭" title="开启|关闭" lay-filter="switch_up" {{ headscale_status }}><div class="layui-unselect layui-form-switch" lay-skin="switch"><div>关闭</div><i></i></div>
                    </div>
                </div>
            </div>
        </div>




        <div class="layui-col-md4">
            <div class="layui-card layui-form" lay-filter="component-form-element">
                <div class="layui-card-header">derp配置</div>
                    <div class="layui-card-body layui-row layui-col-space10">
                    <div class="layui-col-md12">

                       <div class="layui-form-item">


                    <div class="layui-form-item layui-form-text">
                        <textarea name="derpConfig" class="layui-textarea"  lay-verify="required"  style="height: 380px">{{ derp_config  }}</textarea>
                    </div>

                  <div class="layui-form-item">

                      <button class="layui-btn" lay-submit lay-filter="set_derp_config">确认保存</button>

                  </div>

                     </div>
                </div>
            </div>
            </div>


        </div>
    </div>


    </div>
  </div>

  <script src="/static/layui/layui.js"></script>


<script>
layui.use(function(){
  var form = layui.form;
  var layer = layui.layer;
  var $ = layui.$;
  var util = layui.util;
  // 普通事件
  util.on('lay-on', {
    // 获取验证码
    'get_apikey': function(othis){
       $.ajax({
          url:'/api/set/get_apikey',
          type: 'post',
          success:function(res){
            if(res.code == 0){
              layer.msg(res.msg, {icon: 6});
              $('input[name="apiKey"]').val(res.data);
            }else{
              layer.msg(res.msg, {icon: 7});
            }
          }
       });
    },

  });

  // 指定开关事件
  form.on('switch(switch_up)', function(data){


    $.ajax({
      url:'/api/set/switch_headscale',
      type: 'post',
      data: {Switch:this.checked},
      dataType: 'json',
      success:function(res){
        if(res.code == 0){
          layer.msg(res.msg, {icon: 6});
        }else{
          layer.msg(res.msg, {icon: 7});
        }

      }
    });

  });


  // 提交事件
  form.on('submit(set_config)', function(data){
    var field = data.field; // 获取表单字段值

    // 解决关闭对外注册时，字段值为空的问题
    console.log(field.openUserReg);
    if (field.openUserReg == undefined){
      field.openUserReg = "off"
    }

    console.log(field.openUserReg);

    $.ajax({
      url:'/api/set/upset',
      type: 'post',
      data:field,
      dataType: 'json',
      success:function(res){
        if(res.code == 0){
          layer.msg(res.msg, {icon: 6});
        }else{
          layer.msg(res.msg, {icon: 7});
        }

      }
    });

    return false; // 阻止默认 form 跳转
  });


    // 提交事件
  form.on('submit(set_derp_config)', function(data){
    var field = data.field; // 获取表单字段值

    console.log(field);

    $.ajax({
      url:'/api/set/upset',
      type: 'post',
      data:field,
      dataType: 'json',
      success:function(res){
        if(res.code == 0){
          layer.msg(res.msg, {icon: 6});
        }else{
          layer.msg(res.msg, {icon: 7});
        }

      }
    });

    return false; // 阻止默认 form 跳转
  });


});
</script>


</body>
</html>