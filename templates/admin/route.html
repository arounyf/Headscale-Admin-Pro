
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>layui table ç»„ä»¶ç»¼åˆæ¼”ç¤º</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/layui/css/layui.css" rel="stylesheet">
  <link href="/static/adminui/dist/css/admin.css" rel="stylesheet">
</head>
<body>


  
  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-col-md12">
        <div class="layui-card">
          <div class="layui-card-header">è·¯ç”±ä¸­å¿ƒ</div>
          <div class="layui-card-body">
            <table class="layui-hide" id="test-table-index" lay-filter="test-table-index"></table>

            <script type="text/html" id="toolbarDemo">
              <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm" lay-event="reload">åˆ·æ–°</button>
                <button class="layui-btn layui-btn-sm" lay-event="add">è·¯ç”±é€šå‘Š</button>
              </div>
            </script>
             

            {% raw %}
            <script type="text/html" id="test-table-switchTpl">
              <!-- è¿™é‡Œçš„ checked çš„çŠ¶æ€åªæ˜¯æ¼”ç¤º -->
              <input type="checkbox" name="å¯ç”¨" lay-skin="switch" lay-text="æ˜¯|å¦" lay-filter="test-table-sexDemo"
               value="{{ d.enable }}" data-json="{{ encodeURIComponent(JSON.stringify(d)) }}" {{ d.enable == "1" ? 'checked' : '' }}>
               &nbsp;
               <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">åˆ é™¤</a>
            </script>
            {% endraw %}
             

          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/static/layui/layui.js"></script>
  <script>
  layui.config({
    base: '/static/' // é™æ€èµ„æºæ‰€åœ¨è·¯å¾„
  }).use(['index', 'table', 'dropdown','form'], function(){
    var table = layui.table
    ,form = layui.form
    ,$ = layui.$;
    var dropdown = layui.dropdown;
    
    // åˆ›å»ºæ¸²æŸ“å®ä¾‹
    table.render({
      elem: '#test-table-index'
      ,url: '/api/route/getRoute' // æ­¤å¤„ä¸ºé™æ€æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€æ¢æˆçœŸå®æ¥å£
      ,toolbar: '#toolbarDemo'
      ,defaultToolbar: ['filter', 'exports', 'print', {
        title: 'å¸®åŠ©'
        ,layEvent: 'LAYTABLE_TIPS'
        ,icon: 'layui-icon-tips'
      }]
      ,height: 'full-100' // æœ€å¤§é«˜åº¦å‡å»å…¶ä»–å®¹å™¨å·²å æœ‰çš„é«˜åº¦å·®
      ,cellMinWidth: 80
      ,totalRow: true // å¼€å¯åˆè®¡è¡Œ
      ,page: true
      ,cols: [[
            //{type: 'checkbox'}
            {field:'id', title:'ID', fixed: 'left', width:80, unresize: true, sort: true, totalRowText: 'åˆè®¡ï¼š'}
            {% if current_user.role == 'manager' %}
                ,{field:'name', title:'ç”¨æˆ·å',width:200, totalRow: '  {% raw %}{{= d.TOTAL_ROW.count   }}{% endraw %} ğŸ˜Š'}
            {% endif %}
            ,{field:'NodeName', title:'èŠ‚ç‚¹',width:300
                {% if current_user.role == 'user' %}
                    ,totalRow: ' {% raw %}{{= d.TOTAL_ROW.count   }}{% endraw %} ğŸ˜Š'
                {% endif %}
            }
            ,{field:'route', title:'è·¯ç”±',width:280}
            ,{field:'createTime', title: 'åˆ›å»ºæ—¶é—´', width:200, sort: true}
        
        ]]
      ,error: function(res, msg){
        console.log(res, msg)
      }
    });


   
// å·¥å…·æ äº‹ä»¶
table.on('toolbar(test-table-index)', function(obj){
  var $ = layui.$;
  var form = layui.form; // ç¡®ä¿å¼•å…¥formæ¨¡å—
  var util = layui.util;
  var id = obj.config.id;
  var checkStatus = table.checkStatus(id);
  var othis = lay(this);
  switch(obj.event){
    case 'reload':
      var data = checkStatus.data;
      table.reload('test-table-index',true);
    break;
    case 'add':
       layer.open({
      type: 1,
      content: `
        <div class="layui-form" lay-filter="filter-test-layer" style="margin: 20px 35px 30px 0; padding: 10px 0;">
      <div class="demo-login-container">
        <!-- ç¬¬ä¸€ä¸ªä¸‹æ‹‰é€‰æ‹©æ¡† - åŠ¨æ€åŠ è½½èŠ‚ç‚¹ -->
        <div class="layui-form-item">
          <label class="layui-form-label">èŠ‚ç‚¹é€‰æ‹©</label>
          <div class="layui-input-block">
            <select name="nodeId" lay-verify="required" lay-reqtext="è¯·é€‰æ‹©èŠ‚ç‚¹" lay-filter="nodeIdFilter">
              <option value="">åŠ è½½ä¸­...</option>
            </select>
          </div>
        </div>
        
        <!-- ç¬¬äºŒä¸ªä¸‹æ‹‰é€‰æ‹©æ¡† - æ ¹æ®èŠ‚ç‚¹åŠ¨æ€åŠ è½½è·¯ç”± -->
        <div class="layui-form-item">
          <label class="layui-form-label">è·¯ç”±é€‰æ‹©</label>
          <div class="layui-input-block">
            <select name="routes" lay-verify="required" lay-reqtext="è¯·é€‰æ‹©è·¯ç”±">
              <option value="">è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹</option>
            </select>
          </div>
        </div>
      
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="demo-login">æäº¤</button>
          </div>
        </div>
      </div>
    </div>
      `,
  
      area: ['320px', '195px'], // åˆå§‹å®½é«˜
      maxmin: true,
      success: function(layero, index){
        layer.full(index); // æœ€å¤§åŒ–
        
        // é€šè¿‡AJAXè¯·æ±‚è·å–èŠ‚ç‚¹æ•°æ®
        $.ajax({
          url: '/api/node/getNodes?page=1&limit=1000', // èŠ‚ç‚¹åˆ—è¡¨æ¥å£
          type: 'get',
          dataType: 'json',
          success: function(res) {
            if (res.code === "0" && res.data && res.data.length > 0) {
              // æ¸²æŸ“èŠ‚ç‚¹é€‰æ‹©æ¡†
              var nodeId = layero.find('select[name="nodeId"]');
              nodeId.html('<option value="">è¯·é€‰æ‹©èŠ‚ç‚¹</option>');
              res.data.forEach(function(node) {
                var displayText = `${node.name} (${node.ip})`;
                nodeId.append(`<option value="${node.id}">${displayText}</option>`);
              });
              // é‡æ–°æ¸²æŸ“èŠ‚ç‚¹é€‰æ‹©æ¡†
              form.render('select', 'filter-test-layer');
              
              // å…³é”®ä¿®å¤ï¼šä½¿ç”¨layuiçš„formäº‹ä»¶ç›‘å¬èŠ‚ç‚¹é€‰æ‹©å˜åŒ–ï¼ˆè€ŒéåŸç”Ÿchangeï¼‰
              form.on('select(nodeIdFilter)', function(data){
                var nodeId = data.value; // è·å–é€‰ä¸­çš„èŠ‚ç‚¹ID
                var routes = layero.find('select[name="routes"]');
                
                if (!nodeId) {
                  // æœªé€‰æ‹©èŠ‚ç‚¹æ—¶é‡ç½®è·¯ç”±é€‰æ‹©æ¡†
                  routes.html('<option value="">è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹</option>');
                  form.render('select', 'filter-test-layer');
                  return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                routes.html('<option value="">è·¯ç”±åŠ è½½ä¸­...</option>');
                form.render('select', 'filter-test-layer');
                
                // è¯·æ±‚èŠ‚ç‚¹è·¯ç”±ä¿¡æ¯
                $.ajax({
                  url: '/api/node/node_route_info', // èŠ‚ç‚¹è¯¦æƒ…æ¥å£
                  type: 'post',
                  data: { NodeId: nodeId }, // ä¼ é€’èŠ‚ç‚¹IDï¼ˆæ³¨æ„ï¼šå‚æ•°åå¯èƒ½éœ€è¦å’Œåç«¯ä¿æŒä¸€è‡´ï¼‰
                  dataType: 'json',
                  success: function(routeRes) {
                    if (routeRes.code === "0" && routeRes.data && routeRes.data.length > 0) {
                      var availableRoutes = routeRes.data[0].availableRoutes || [];
                      
                      if (availableRoutes.length > 0) {
                        routes.html('<option value="">è¯·é€‰æ‹©éœ€è¦é€šå‘Šè·¯ç”±</option>');
                        availableRoutes.forEach(function(route) {
                          routes.append(`<option value="${route}">${route}</option>`);
                        });
                      } else {
                        routes.html('<option value="">è¯¥èŠ‚ç‚¹æ— å¯ç”¨è·¯ç”±</option>');
                      }
                    } else {
                      routes.html(`<option value="">${routeRes.msg || 'è·¯ç”±æ•°æ®è·å–å¤±è´¥'}</option>`);
                    }
                    form.render('select', 'filter-test-layer');
                  },
                  error: function(xhr) {
                    console.error('è·¯ç”±è¯·æ±‚å¤±è´¥ï¼š', xhr); // æ‰“å°é”™è¯¯ä¿¡æ¯ç”¨äºè°ƒè¯•
                    routes.html('<option value="">è·¯ç”±è¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰</option>');
                    form.render('select', 'filter-test-layer');
                  }
                });
              });
            } else {
              layero.find('select[name="nodeId"]').html(
                `<option value="">${res.msg || 'æš‚æ— èŠ‚ç‚¹æ•°æ®'}</option>`
              );
              form.render('select', 'filter-test-layer');
            }
          },
          error: function(xhr) {
            console.error('èŠ‚ç‚¹è¯·æ±‚å¤±è´¥ï¼š', xhr); // æ‰“å°é”™è¯¯ä¿¡æ¯ç”¨äºè°ƒè¯•
            layero.find('select[name="nodeId"]').html(
              '<option value="">èŠ‚ç‚¹æ•°æ®åŠ è½½å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰</option>'
            );
            form.render('select', 'filter-test-layer');
          }
        });
        
        // ç›‘å¬è¡¨å•æäº¤
        form.on('submit(demo-login)', function(data) {

          
          // AJAXæäº¤é€»è¾‘
          
          $.ajax({
            url: '/api/node/approve_routes',
            type: 'post',
            data: data.field,
            success: function(res) {
              if (res.code === "0") {
                layer.msg(res.msg, {icon: 6});
                // layer.closeAll();
              } else {
                layer.msg(res.msg || 'æ“ä½œå¤±è´¥', {icon: 7});
              }
            }
          });
          
          return false; // é˜»æ­¢é»˜è®¤è¡¨å•æäº¤
        });
      }
    });

    break;
  };
});
   

  });
  </script>
</body>
</html>

