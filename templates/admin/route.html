<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>layui table ç»„ä»¶ç»¼åˆæ¼”ç¤º</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/layui/css/layui.css" rel="stylesheet">
  <link href="/static/adminui/dist/css/admin.css" rel="stylesheet">
</head>
<body>


  
  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-col-md12">
        <div class="layui-card">
          <div class="layui-card-header">è·¯ç”±ä¸­å¿ƒ</div>
          <div class="layui-card-body">
            <table class="layui-hide" id="test-table-index" lay-filter="test-table-index"></table>

            <script type="text/html" id="toolbarDemo">
              <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm" lay-event="reload">åˆ·æ–°</button>
                <button class="layui-btn layui-btn-sm" lay-event="add">è·¯ç”±é€šå‘Š</button>
              </div>
            </script>
             

            {% raw %}
            <script type="text/html" id="test-table-switchTpl">
              <!-- è¿™é‡Œçš„ checked çš„çŠ¶æ€åªæ˜¯æ¼”ç¤º -->
              <input type="checkbox" name="å¯ç”¨" lay-skin="switch" lay-text="æ˜¯|å¦" lay-filter="test-table-sexDemo"
               value="{{ d.enable }}" data-json="{{ encodeURIComponent(JSON.stringify(d)) }}" {{ d.enable == "1" ? 'checked' : '' }}>
               &nbsp;
               <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">åˆ é™¤</a>
            </script>
            {% endraw %}
             

          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/static/layui/layui.js"></script>
  <script>
  layui.config({
    base: '/static/' // é™æ€èµ„æºæ‰€åœ¨è·¯å¾„
  }).use(['index', 'table', 'dropdown','form'], function(){
    var table = layui.table
    ,form = layui.form
    ,$ = layui.$;
    var dropdown = layui.dropdown;
    
    // åˆ›å»ºæ¸²æŸ“å®ä¾‹
    table.render({
      elem: '#test-table-index'
      ,url: '/api/route/getRoute' // æ­¤å¤„ä¸ºé™æ€æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€æ¢æˆçœŸå®æ¥å£
      ,toolbar: '#toolbarDemo'
      ,defaultToolbar: ['filter', 'exports', 'print', {
        title: 'å¸®åŠ©'
        ,layEvent: 'LAYTABLE_TIPS'
        ,icon: 'layui-icon-tips'
      }]
      ,height: 'full-100' // æœ€å¤§é«˜åº¦å‡å»å…¶ä»–å®¹å™¨å·²å æœ‰çš„é«˜åº¦å·®
      ,cellMinWidth: 80
      ,totalRow: true // å¼€å¯åˆè®¡è¡Œ
      ,page: true
      ,cols: [[
            //{type: 'checkbox'}
            {field:'id', title:'ID', fixed: 'left', width:80, unresize: true, sort: true, totalRowText: 'åˆè®¡ï¼š'}
            {% if current_user.role == 'manager' %}
                ,{field:'name', title:'ç”¨æˆ·å',width:200, totalRow: '  {% raw %}{{= d.TOTAL_ROW.count   }}{% endraw %} ğŸ˜Š'}
            {% endif %}
            ,{field:'NodeName', title:'èŠ‚ç‚¹',width:300
                {% if current_user.role == 'user' %}
                    ,totalRow: ' {% raw %}{{= d.TOTAL_ROW.count   }}{% endraw %} ğŸ˜Š'
                {% endif %}
            }
            ,{field:'route', title:'è·¯ç”±',width:280}
            ,{field:'createTime', title: 'åˆ›å»ºæ—¶é—´', width:200, sort: true}
        
        ]]
      ,error: function(res, msg){
        console.log(res, msg)
      }
    });


   
// å·¥å…·æ äº‹ä»¶
table.on('toolbar(test-table-index)', function(obj){
  var $ = layui.$;
  var form = layui.form; // ç¡®ä¿å¼•å…¥formæ¨¡å—
  var util = layui.util;
  var id = obj.config.id;
  var checkStatus = table.checkStatus(id);
  var othis = lay(this);
  switch(obj.event){
    case 'reload':
      var data = checkStatus.data;
      table.reload('test-table-index',true);
    break;
    case 'add':
       layer.open({
      type: 1,
      content: `
        <div class="layui-form" lay-filter="filter-test-layer" style="margin: 20px 35px 30px 0; padding: 10px 0;">
      <div class="demo-login-container">
        {% if current_user.role == 'manager' %}
        <!-- ç”¨æˆ·é€‰æ‹©ä¸‹æ‹‰æ¡† - ä»…ç®¡ç†å‘˜æ˜¾ç¤º -->
        <div class="layui-form-item">
          <label class="layui-form-label">ç”¨æˆ·é€‰æ‹©</label>
          <div class="layui-input-block">
            <select name="userId" lay-verify="required" lay-reqtext="è¯·é€‰æ‹©ç”¨æˆ·" lay-filter="userIdFilter">
              <option value="">åŠ è½½ä¸­...</option>
            </select>
          </div>
        </div>
        {% endif %}
        
        <!-- èŠ‚ç‚¹é€‰æ‹©ä¸‹æ‹‰æ¡† -->
        <div class="layui-form-item">
          <label class="layui-form-label">èŠ‚ç‚¹é€‰æ‹©</label>
          <div class="layui-input-block">
            <select name="nodeId" lay-verify="required" lay-reqtext="è¯·é€‰æ‹©èŠ‚ç‚¹" lay-filter="nodeIdFilter">
              <option value="">åŠ è½½ä¸­...</option>
            </select>
          </div>
        </div>
        
        <!-- è·¯ç”±é€‰æ‹©ä¸‹æ‹‰æ¡† -->
        <div class="layui-form-item">
          <label class="layui-form-label">è·¯ç”±é€‰æ‹©</label>
          <div class="layui-input-block">
            <select name="routes" lay-verify="required" lay-reqtext="è¯·é€‰æ‹©è·¯ç”±">
              <option value="">è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹</option>
            </select>
          </div>
        </div>
      
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="demo-login">æäº¤</button>
          </div>
        </div>
      </div>
    </div>
      `,
  
      // æ ¹æ®è§’è‰²è°ƒæ•´å¼¹çª—é«˜åº¦ï¼ˆç®¡ç†å‘˜å¤šä¸€ä¸ªç”¨æˆ·é€‰æ‹©æ¡†ï¼Œé«˜åº¦å¢åŠ 50pxï¼‰
      area: ['320px', {% if current_user.role == 'manager' %}'295px'{% else %}'245px'{% endif %}],
      maxmin: true,
      success: function(layero, index){
        layer.full(index); // æœ€å¤§åŒ–
        
        // å­˜å‚¨ç”¨æˆ·åˆ—è¡¨æ•°æ®ï¼ˆä»…ç®¡ç†å‘˜éœ€è¦ï¼‰
        var userList = [];
        // å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆæ™®é€šç”¨æˆ·ç›´æ¥ä½¿ç”¨ï¼‰
        var currentUser = {
          id: '{{ current_user.id }}',
          username: '{{ current_user.username }}'
        };
        
        // ä»…ç®¡ç†å‘˜åŠ è½½ç”¨æˆ·åˆ—è¡¨
        {% if current_user.role == 'manager' %}
        $.ajax({
          url: '/api/user/getUsers', // ç”¨æˆ·åˆ—è¡¨æ¥å£
          type: 'get',
          dataType: 'json',
          success: function(res) {
            if (res.code === "0" && res.data && res.data.length > 0) {
              userList = res.data;
              var userIdSelect = layero.find('select[name="userId"]');
              userIdSelect.html('<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>');
              res.data.forEach(function(user) {
                userIdSelect.append(`<option value="${user.id}">${user.userName}</option>`);
              });
            } else {
              layero.find('select[name="userId"]').html(`<option value="">${res.msg || 'æš‚æ— ç”¨æˆ·æ•°æ®'}</option>`);
            }
            form.render('select', 'filter-test-layer');
          },
          error: function(xhr) {
            console.error('ç”¨æˆ·è¯·æ±‚å¤±è´¥ï¼š', xhr);
            layero.find('select[name="userId"]').html('<option value="">ç”¨æˆ·æ•°æ®åŠ è½½å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰</option>');
            form.render('select', 'filter-test-layer');
          }
        });
        {% endif %}
        
        // åŠ è½½èŠ‚ç‚¹åˆ—è¡¨ï¼ˆç®¡ç†å‘˜éœ€é€‰æ‹©ç”¨æˆ·ååŠ è½½ï¼Œæ™®é€šç”¨æˆ·ç›´æ¥åŠ è½½ï¼‰
        var loadNodes = function(userId, userName) {
          var nodeSelect = layero.find('select[name="nodeId"]');
          var routeSelect = layero.find('select[name="routes"]');
          
          // é‡ç½®èŠ‚ç‚¹å’Œè·¯ç”±é€‰æ‹©æ¡†çŠ¶æ€
          nodeSelect.html('<option value="">èŠ‚ç‚¹åŠ è½½ä¸­...</option>');
          routeSelect.html('<option value="">è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹</option>');
          form.render('select', 'filter-test-layer');
          
          // è¯·æ±‚èŠ‚ç‚¹åˆ—è¡¨æ¥å£ï¼ˆä¿æŒåŸæ¥å£åœ°å€ä¸å˜ï¼‰
          $.ajax({
            url: '/api/node/getNodes',
            type: 'get',
            data: { 
              userId: userId,
              search_name: userName // ä¿æŒåŸå‚æ•°ä¼ é€’é€»è¾‘
            },
            dataType: 'json',
            success: function(res) {
              if (res.code === "0" && res.data && res.data.length > 0) {
                nodeSelect.html('<option value="">è¯·é€‰æ‹©èŠ‚ç‚¹</option>');
                res.data.forEach(function(node) {
                  var displayText = `${node.name} (${node.ip})`;
                  nodeSelect.append(`<option value="${node.id}">${displayText}</option>`);
                });
              } else {
                nodeSelect.html(`<option value="">${res.msg || 'è¯¥ç”¨æˆ·æ— å¯ç”¨èŠ‚ç‚¹'}</option>`);
              }
              form.render('select', 'filter-test-layer');
            },
            error: function(xhr) {
              console.error('èŠ‚ç‚¹è¯·æ±‚å¤±è´¥ï¼š', xhr);
              nodeSelect.html('<option value="">èŠ‚ç‚¹æ•°æ®åŠ è½½å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰</option>');
              form.render('select', 'filter-test-layer');
            }
          });
        };
        
        // ç®¡ç†å‘˜ç›‘å¬ç”¨æˆ·é€‰æ‹©å˜åŒ–
        {% if current_user.role == 'manager' %}
        form.on('select(userIdFilter)', function(data){
          var userId = data.value;
          if (!userId) {
            layero.find('select[name="nodeId"]').html('<option value="">è¯·å…ˆé€‰æ‹©ç”¨æˆ·</option>');
            form.render('select', 'filter-test-layer');
            return;
          }
          // æ ¹æ®ç”¨æˆ·IDæŸ¥æ‰¾ç”¨æˆ·å
          var userName = '';
          for (var i = 0; i < userList.length; i++) {
            if (userList[i].id == userId) {
              userName = userList[i].userName;
              break;
            }
          }
          // åŠ è½½è¯¥ç”¨æˆ·çš„èŠ‚ç‚¹
          loadNodes(userId, userName);
        });
        {% else %}
        // æ™®é€šç”¨æˆ·ç›´æ¥åŠ è½½è‡ªå·±çš„èŠ‚ç‚¹
        loadNodes(currentUser.id, currentUser.username);
        {% endif %}
        
        // ç›‘å¬èŠ‚ç‚¹é€‰æ‹©å˜åŒ–ï¼ˆä¿æŒåŸé€»è¾‘ä¸å˜ï¼‰
        form.on('select(nodeIdFilter)', function(data){
          var nodeId = data.value;
          var routesSelect = layero.find('select[name="routes"]');
          
          if (!nodeId) {
            routesSelect.html('<option value="">è¯·å…ˆé€‰æ‹©èŠ‚ç‚¹</option>');
            form.render('select', 'filter-test-layer');
            return;
          }
          
          routesSelect.html('<option value="">è·¯ç”±åŠ è½½ä¸­...</option>');
          form.render('select', 'filter-test-layer');
          
          $.ajax({
            url: '/api/node/node_route_info',
            type: 'post',
            data: { NodeId: nodeId },
            dataType: 'json',
            success: function(routeRes) {
              if (routeRes.code === "0" && routeRes.data && routeRes.data.length > 0) {
                var availableRoutes = routeRes.data[0].availableRoutes || [];
                if (availableRoutes.length > 0) {
                  routesSelect.html('<option value="">è¯·é€‰æ‹©éœ€è¦é€šå‘Šè·¯ç”±</option>');
                  availableRoutes.forEach(function(route) {
                    routesSelect.append(`<option value="${route}">${route}</option>`);
                  });
                } else {
                  routesSelect.html('<option value="">è¯¥èŠ‚ç‚¹æ— å¯ç”¨è·¯ç”±</option>');
                }
              } else {
                routesSelect.html(`<option value="">${routeRes.msg || 'è·¯ç”±æ•°æ®è·å–å¤±è´¥'}</option>`);
              }
              form.render('select', 'filter-test-layer');
            },
            error: function(xhr) {
              console.error('è·¯ç”±è¯·æ±‚å¤±è´¥ï¼š', xhr);
              routesSelect.html('<option value="">è·¯ç”±è¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰</option>');
              form.render('select', 'filter-test-layer');
            }
          });
        });
        
        // ç›‘å¬è¡¨å•æäº¤ï¼ˆä¿æŒåŸé€»è¾‘ä¸å˜ï¼‰
        form.on('submit(demo-login)', function(data) {
          // æ™®é€šç”¨æˆ·è¡¥å……userIdå‚æ•°
          {% if current_user.role != 'manager' %}
          data.field.userId = currentUser.id;
          {% endif %}
          
          $.ajax({
            url: '/api/node/approve_routes',
            type: 'post',
            data: data.field,
            success: function(res) {
              if (res.code === "0") {
                layer.msg(res.msg, {icon: 6});
                layer.close(index);
                table.reload('test-table-index');
              } else {
                layer.msg(res.msg || 'æ“ä½œå¤±è´¥', {icon: 7});
              }
            }
          });
          
          return false;
        });
      }
    });

    break;
  };
});
   

  });
  </script>
</body>
</html>