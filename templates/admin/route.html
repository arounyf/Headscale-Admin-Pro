
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>layui table 组件综合演示</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/layui/css/layui.css" rel="stylesheet">
  <link href="/static/adminui/dist/css/admin.css" rel="stylesheet">
</head>
<body>


  
  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-col-md12">
        <div class="layui-card">
          <div class="layui-card-header">路由中心</div>
          <div class="layui-card-body">
            <table class="layui-hide" id="test-table-index" lay-filter="test-table-index"></table>

            <script type="text/html" id="toolbarDemo">
              <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm" lay-event="reload">刷新</button>
                <button class="layui-btn layui-btn-sm" lay-event="add">路由通告</button>
              </div>
            </script>
             

            {% raw %}
            <script type="text/html" id="test-table-switchTpl">
              <!-- 这里的 checked 的状态只是演示 -->
              <input type="checkbox" name="启用" lay-skin="switch" lay-text="是|否" lay-filter="test-table-sexDemo"
               value="{{ d.enable }}" data-json="{{ encodeURIComponent(JSON.stringify(d)) }}" {{ d.enable == "1" ? 'checked' : '' }}>
               &nbsp;
               <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
            </script>
            {% endraw %}
             

          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/static/layui/layui.js"></script>
  <script>
  layui.config({
    base: '/static/' // 静态资源所在路径
  }).use(['index', 'table', 'dropdown','form'], function(){
    var table = layui.table
    ,form = layui.form
    ,$ = layui.$;
    var dropdown = layui.dropdown;
    
    // 创建渲染实例
    table.render({
      elem: '#test-table-index'
      ,url: '/api/route/getRoute' // 此处为静态模拟数据，实际使用时需换成真实接口
      ,toolbar: '#toolbarDemo'
      ,defaultToolbar: ['filter', 'exports', 'print', {
        title: '帮助'
        ,layEvent: 'LAYTABLE_TIPS'
        ,icon: 'layui-icon-tips'
      }]
      ,height: 'full-100' // 最大高度减去其他容器已占有的高度差
      ,cellMinWidth: 80
      ,totalRow: true // 开启合计行
      ,page: true
      ,cols: [[
            //{type: 'checkbox'}
            {field:'id', title:'ID', fixed: 'left', width:80, unresize: true, sort: true, totalRowText: '合计：'}
            {% if current_user.role == 'manager' %}
                ,{field:'name', title:'用户名',width:200, totalRow: '  {% raw %}{{= d.TOTAL_ROW.count   }}{% endraw %} 😊'}
            {% endif %}
            ,{field:'NodeName', title:'节点',width:300
                {% if current_user.role == 'user' %}
                    ,totalRow: ' {% raw %}{{= d.TOTAL_ROW.count   }}{% endraw %} 😊'
                {% endif %}
            }
            ,{field:'route', title:'路由',width:280}
            ,{field:'createTime', title: '创建时间', width:200, sort: true}
        
        ]]
      ,error: function(res, msg){
        console.log(res, msg)
      }
    });


   
// 工具栏事件
table.on('toolbar(test-table-index)', function(obj){
  var $ = layui.$;
  var form = layui.form; // 确保引入form模块
  var util = layui.util;
  var id = obj.config.id;
  var checkStatus = table.checkStatus(id);
  var othis = lay(this);
  switch(obj.event){
    case 'reload':
      var data = checkStatus.data;
      table.reload('test-table-index',true);
    break;
    case 'add':
       layer.open({
      type: 1,
      content: `
        <div class="layui-form" lay-filter="filter-test-layer" style="margin: 20px 35px 30px 0; padding: 10px 0;">
      <div class="demo-login-container">
        <!-- 第一个下拉选择框 - 动态加载节点 -->
        <div class="layui-form-item">
          <label class="layui-form-label">节点选择</label>
          <div class="layui-input-block">
            <select name="nodeId" lay-verify="required" lay-reqtext="请选择节点" lay-filter="nodeIdFilter">
              <option value="">加载中...</option>
            </select>
          </div>
        </div>
        
        <!-- 第二个下拉选择框 - 根据节点动态加载路由 -->
        <div class="layui-form-item">
          <label class="layui-form-label">路由选择</label>
          <div class="layui-input-block">
            <select name="routes" lay-verify="required" lay-reqtext="请选择路由">
              <option value="">请先选择节点</option>
            </select>
          </div>
        </div>
      
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="demo-login">提交</button>
          </div>
        </div>
      </div>
    </div>
      `,
  
      area: ['320px', '195px'], // 初始宽高
      maxmin: true,
      success: function(layero, index){
        layer.full(index); // 最大化
        
        // 通过AJAX请求获取节点数据
        $.ajax({
          url: '/api/node/getNodes?page=1&limit=1000', // 节点列表接口
          type: 'get',
          dataType: 'json',
          success: function(res) {
            if (res.code === "0" && res.data && res.data.length > 0) {
              // 渲染节点选择框
              var nodeId = layero.find('select[name="nodeId"]');
              nodeId.html('<option value="">请选择节点</option>');
              res.data.forEach(function(node) {
                var displayText = `${node.name} (${node.ip})`;
                nodeId.append(`<option value="${node.id}">${displayText}</option>`);
              });
              // 重新渲染节点选择框
              form.render('select', 'filter-test-layer');
              
              // 关键修复：使用layui的form事件监听节点选择变化（而非原生change）
              form.on('select(nodeIdFilter)', function(data){
                var nodeId = data.value; // 获取选中的节点ID
                var routes = layero.find('select[name="routes"]');
                
                if (!nodeId) {
                  // 未选择节点时重置路由选择框
                  routes.html('<option value="">请先选择节点</option>');
                  form.render('select', 'filter-test-layer');
                  return;
                }
                
                // 显示加载状态
                routes.html('<option value="">路由加载中...</option>');
                form.render('select', 'filter-test-layer');
                
                // 请求节点路由信息
                $.ajax({
                  url: '/api/node/node_info', // 节点详情接口
                  type: 'post',
                  data: { NodeId: nodeId }, // 传递节点ID（注意：参数名可能需要和后端保持一致）
                  dataType: 'json',
                  success: function(routeRes) {
                    if (routeRes.code === "0" && routeRes.data && routeRes.data.length > 0) {
                      var availableRoutes = routeRes.data[0].availableRoutes || [];
                      
                      if (availableRoutes.length > 0) {
                        routes.html('<option value="">请选择需要通告路由</option>');
                        availableRoutes.forEach(function(route) {
                          routes.append(`<option value="${route}">${route}</option>`);
                        });
                      } else {
                        routes.html('<option value="">该节点无可用路由</option>');
                      }
                    } else {
                      routes.html(`<option value="">${routeRes.msg || '路由数据获取失败'}</option>`);
                    }
                    form.render('select', 'filter-test-layer');
                  },
                  error: function(xhr) {
                    console.error('路由请求失败：', xhr); // 打印错误信息用于调试
                    routes.html('<option value="">路由请求失败（网络错误）</option>');
                    form.render('select', 'filter-test-layer');
                  }
                });
              });
            } else {
              layero.find('select[name="nodeId"]').html(
                `<option value="">${res.msg || '暂无节点数据'}</option>`
              );
              form.render('select', 'filter-test-layer');
            }
          },
          error: function(xhr) {
            console.error('节点请求失败：', xhr); // 打印错误信息用于调试
            layero.find('select[name="nodeId"]').html(
              '<option value="">节点数据加载失败（网络错误）</option>'
            );
            form.render('select', 'filter-test-layer');
          }
        });
        
        // 监听表单提交
        form.on('submit(demo-login)', function(data) {

          
          // AJAX提交逻辑
          
          $.ajax({
            url: '/api/node/approve_routes',
            type: 'post',
            data: data.field,
            success: function(res) {
              if (res.code === "0") {
                layer.msg(res.msg, {icon: 6});
                // layer.closeAll();
              } else {
                layer.msg(res.msg || '操作失败', {icon: 7});
              }
            }
          });
          
          return false; // 阻止默认表单提交
        });
      }
    });

    break;
  };
});
   

  });
  </script>
</body>
</html>

